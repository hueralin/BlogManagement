---
title: "HTTPS"
date: 2019-10-12T14:11:39+08:00
draft: false
categories: ['计算机网络']
tags: ['计算机网络', 'HTTP']
---

## HTTP协议的弊端

### 报文明文通信

由于HTTP协议本身没有加密手段，所以无法对通信的内容进行加密。因此，一般情况下的HTTP通信都是明文通信的，索引很容易被截获窃听。为了保证通信的安全，必须采取某种外部加密措施。

加密的方式一般有两种，对**通信的加密**和**对内容的加密**。

**对通信的加密**就是 HTTP + SSL/TLS 这种，在真正通信之前先建立一个加密的通信线路。

**对内容的加密**就是先对要发送的内容进行加密，把加密后的内容放进报文里发送，前提是要求客户端和服务器同 时具备加密和解密机制。

### 不进行身份验证

HTTP是不进行身份验证的。在TCP三次握手过程中也仅仅是验证双方的收发能力是否完好，并不对通信的双方进行身份验证。也就是说服务器对发来的请求照单全收并且会给对方一个响应。

1. 无法确定请求发送的目的服务器是真正的服务器。  
2. 无法确定收到响应的客户端是真正的客户端。  
3. 无法确定客户端用户是否有访问权限，因为服务器上的有些信息需要有权限的用户才能访问。  
4. 服务器照单全收，包括垃圾请求（DoS）。

### 无法验证报文的完整性

因为HTTP报文是明文发送的，所以中途有可能被篡改，但是HTTP协议没有数据验证功能，对方接受到的数据可能是被篡改过的。例如中间人攻击，当我们在网站上下载一个文件时，文件在传输过程中被篡改，客户端无法确认下载的是否为正确的文件，可能是带有病毒的文件。

为了有效地防止上面的弊端，我们有必要使用HTTPS。既然单独使用HTTP协议无法确保安全，我们就必修将HTTP协议和其他协议结合起来，共同完成目标。

## HTTPS

**HTTPS = HTTP + 加密 + 身份认证 + 数据完整性验证**

HTTPS 即 HTTP Secure，是身披SSL外壳的HTTP。传统的通信方式是HTTP直接和TCP通信，而HTTPS在中间加了一层SSL，演变成先和 SSL通 信，再由 SSL和 TCP 通信。有了SSL加持，HTTP 就拥有了 HTTPS 的加密、证书和完整性保护 这些功能。

### 公钥加密技术

现在常用的加密技术里有两种：对称加密　和　非对称加密。

对称加密就是双方都持有约定好的加密解密算法，但是一旦双方约定好的加密解密算法被第三方知道了，加密也就没有了意义。所以如何将约定好的加密解密算法传给对方是个问题，而且还得保存好自己手中的密钥。

非对称加密采用了双密钥的方法，一对公私钥。公钥加密私钥解密，或者私钥加密公钥解密。公钥可以公开，四月自己保存好。这样，传递只传公钥，不怕被别人知道，毕竟只能私钥解开。所以公钥加密，私钥解密比较安全。

### 混合加密

HTTPS采取的是对称加密和非对称加密相结合的方法，因为非对称加密的开销比较大。HTTPS使用非对称加密传递对称加密所需要的密钥，保证密钥的安全，然后再使用对称加密方法进行通信。

### 证明公钥正确性（可信度）的证书

即使使用了“混合加密”也是有问题的，因为我们没法确认公钥的安全性，万一拿到的公钥是假的呢？如果连SSL这一层都无法安全通过，那接下来的通信一定是不可靠的。

为了解决上面的问题，我们使用了一种叫做证书的东西，由数字证书颁发机构（CA）发布的一种电子凭证。

**申请流程：**  
1. 申请人向CA提出公钥证书的申请  
2. CA对使用自己的私钥对申请人的一些基本信息以及申请人的公钥进行签名（相当于加盖发证书机 构的公章）  
3. 将公钥放到公钥证书中，发给申请人

**客户端收到服务器发来的公钥证书后的验证流程：**  
客户端使用CA的公钥（一般内置在浏览器中），对证书上的数字签名进行验证，验证通过说明是权威机构（说明机构可信）颁发的证书，该服务器的公钥可信，身份可信。

### HTTPS通信流程  

![《图解HTTP》](/img/posts/https.png)

1. 客户端通过发送 Client Hello 报文开始 SSL通信。报文中包含客户端支持的 SSL的指定版本、加密组件列表（所使用的加密算法及密钥长度等）。（你看，我支持这些加密算法，你支持哪个？选一下吧！）  
2. 服务器可进行 SSL通信时，会以 Server Hello 报文作为应答。报文中包含 SSL版本以及加密组件。加密组件内容是从接收到的客户端加密组件内筛选出来的。（我支持这个，咱就用这个吧）。  
3. 服务器发送 Certificate 报文，报文中包含公开密钥证书。  
4. 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的**“SSL握手协商”**部分结束。  
5. SSL第一次握手结束。  
6. 客户端以 Client Key Exchange 报文作为回应。报文内容为用服务器公钥加密的一串随机数字。（我用你的公钥加密了一串数字，看看你能不能打开）。  
7. 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用上面那串随机数字作为密钥加密。（你一定要打开哦......不然咱俩就没法通信了呢......嘿嘿嘿~~~）。  
8. 客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。  
9. 服务器同样发送 Change Cipher Spec 报文。（我解出来了，你看是不是这串随机数字）。  
10. 服务器同样发送 Finished 报文。  
11. 服务器和客户端的 Finished 报文交换完毕之后，SSL连接 就算建立完成。当然，通信会受到 SSL的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。  

在以上流程中，应用层发送数据时会附加一种叫做 MAC（Message Authentication Code）的报文摘要。MAC 能够查知报文是否遭到篡改，从而保护报文的完整性。MAC是通过某种算法对报文内容做的散列，对方拿到后用同样的方法对保温内容做散列，看两个散列值是否一样，一样的话说明没有被篡改。

### HTTPS 比 HTTP慢  

慢！确实慢！能不慢吗，搞了那么多加密解密，情报传递，心累！《图解HTTP》上说比HTTP能慢到2-100倍！妈耶~

所以，HTTPS也不能滥用。如果是非敏感信息的话，可以考虑使用HTTP，但如果是账号密码等敏感信息，据不得不使用HTTPS了。
