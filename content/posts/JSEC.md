---
title: "JS执行环境，作用域链，变量对象/活动对象"
date: 2019-09-02T11:20:42+08:00
draft: false,
categories: ['随便学学']
---

JS的重点内容之一，虽然不会在面试题中直接那么问，多半给你出一段代码，看输出什么。  

我觉得了解了这部分内容，能让我们对整个JS的执行流程有个详细、准确地认识，在面对工作中的一些错误也能快速且正确的排错。  

### JS执行环境  

JS的执行环境又被称为执行上下文（Execution context），简称EC。顾名思义，JS执行环境就是JS执行时才会存在的环境，常见的执行环境有两种：全局执行环境和函数执行环境。当JS代码执行的时候，我们会进入不同的执行环境，这些执行环境会构成一个执行环境栈。  

**EC的组成**：  
1. 变量对象（VO）：包含变量的对象，无法被访问    
2. [[scope]]：作用域链，由变量对象构成，该属性是指向作用域链头节点的指针  
3. this指针：指向环境对象（也是一个普通对象），而不是执行环境EC  

**EC的创建**：  

EC是在调用函数的时候创建的，一个EC的生命周期分为两个阶段：创建阶段 和 执行阶段：  
1. 创建阶段：此时EC创建变量对象，建立作用域链，确定this的指向，  
2. 代码执行阶段：完成变量赋值，其他函数调用等代码的执行  

其中变量对象的创建也是个重点，这里涉及到了**预编译**的问题：  
**变量对象的创建**：  
1. 根据函数的参数，建立arguments对象（类数组，将参数值保存在下标中）。  
2. 函数声明提升：扫描所有的函数声明，将函数名作为变量对象的属性名，属性值为函数在内存中的地址，如果属性名存在，则会被覆盖。  
3. 变量声明提升：扫描所有的变量声明，将变量名作为变量对象的属性名，属性值初始化为undefined，如果属性名存在，则会跳过，不覆盖（防止同名的函数被覆盖为undefined，毕竟函数是一等公民嘛～）。  

**注意：在代码执行阶段的时候，变量才会被赋值，之前一直都是undefined。**

由上可知，作用域其实就是一个变量对象。那么什么是变量对象？

### 变量对象（VO）  

变量对象存储了EC中定义的变量和函数声明，“这个对象是规范上的，或者说是引擎实现上的，不可在JS环境中访问到”。  

### 活动对象（AO）  

“活动对象其实就是变量对象的激活状态” 这是我在大多数博文中找到的介绍，即当执行流进入一个函数时，EC会被创建，变量对象会被创建，变量对象被激活成为活动对象。  

此处有**争议**：  
1. 根据“函数是被一级一级的调用的”，我是不是可以说这一级一级向下执行的函数的变量对象都是活动对象呢？毕竟这些函数都被执行了。所以说，我觉得 “活动对象” 应该是处于作用域链顶端的变量对象，该变量对象处于最近被执行的EC。  
2. 另一种说法，不是存在一个执行环境栈嘛，当A函数里执行了B函数，那么B函数入栈，A函数可以想象成处于一种 “休眠” 状态，B函数才算真正被执行。所以B函数里的环境对象、变量对象被创建，变量对象被激活为活动对象。（Emmm，好像也有道理。哈！都是我的猜想😂）  

当函数执行完毕，它的执行环境会被销毁，活动对象也会跟着销毁。但这是在一般的情况下，如果是 **[闭包](https://hueralin.github.io/2019/closure/)**，那就得另当别论。假设A函数里返回了B函数，B函数引用着A函数执行环境里的活动对象。当A函数执行完毕后，A函数的环境变量被销毁，但是活动对象依然存在于作用域的顶端。当返回的函数被调用时，会创建自己的执行环境和活动对象（此时应该就有两个活动对象），闭包函数的活动对象里面引用着上一个活动对象，当闭包函数执行完后，两个活动对象都将被销毁。  

### 作用域链  

作用域分为两种：全局作用域 和 局部作用域。  
前面说过，作用域链其实就是变量对象，但并不是一个，而是一串儿😂。我们所说的局部作用域其实就是当前执行环境的变量对象，我们在查找一个变量的时候，如果在当前变量对象里面查不到的话，就会顺着作用域链一级一级的向上查找，直到全局作用域，因此全局作用域处于作用域链的末端。


[最后，推荐一篇知乎上的帖子，上面讨论的很详细。（尤其是那几个图，很直观，我也就不再放图了😂）](https://www.zhihu.com/question/36393048)  

(我听见你在说我懒了......)
